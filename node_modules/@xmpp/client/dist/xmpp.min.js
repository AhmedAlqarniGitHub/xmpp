!function(t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).XMPP=t()}(function(){var t=function(e){var n;return function(t){return n||e(n={exports:{},parent:t},n.exports),n.exports}},e=t(function(t,e){"use strict";var n;n=function(t,e){function n(){}n.prototype.name="PLAIN",n.prototype.clientFirst=!0,n.prototype.response=function(t){var e="";return e+=t.authzid||"",e+="\0",e+=t.username,e+="\0",e+=t.password},n.prototype.challenge=function(t){return this},e.exports=n},"object"==typeof e&&n(0,t)}),n=t(function(t,e){"use strict";var n;n=function(t,e){function n(){}n.prototype.name="ANONYMOUS",n.prototype.clientFirst=!0,n.prototype.response=function(t){return t.trace||""},n.prototype.challenge=function(t){},e.exports=n},"object"==typeof e&&n(0,t)}),r=t(function(t,e){"use strict";var n;n=function(t,e){function n(){this._mechs=[]}n.prototype.use=function(t,e){return e||(t=(e=t).prototype.name),this._mechs.push({name:t,mech:e}),this},n.prototype.create=function(t){for(var e=0,n=this._mechs.length;e<n;e++)for(var r=0,o=t.length;r<o;r++){var i=this._mechs[e];if(i.name==t[r])return new i.mech}return null},e.exports=n},"object"==typeof e&&n(0,t)}),u={};((u=function(t){return t&&t.__esModule?t:{default:t}}).default=u).__esModule=!0;var o={};((o=function(t,e){if(null==t)return{};for(var n,r={},o=Object.keys(t),i=0;i<o.length;i++)n=o[i],0<=e.indexOf(n)||(r[n]=t[n]);return r}).default=o).__esModule=!0;var i={};function s(t,e){return((i=s=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t}).default=i).__esModule=!0,s(t,e)}((i=s).default=i).__esModule=!0;var c={};((c=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)}).default=c).__esModule=!0;var a={};function l(t){return((a=l=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)}).default=a).__esModule=!0,l(t)}((a=l).default=a).__esModule=!0;var f={};((f=function(t){return-1!==Function.toString.call(t).indexOf("[native code]")}).default=f).__esModule=!0;var h={};((h=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}).default=h).__esModule=!0;var p={};function d(t,e,n){return h()?((p=d=Reflect.construct).default=p).__esModule=!0:((p=d=function(t,e,n){var r=[null];r.push.apply(r,e);r=new(Function.bind.apply(t,r));return n&&i(r,n.prototype),r}).default=p).__esModule=!0,d.apply(null,arguments)}((p=d).default=p).__esModule=!0;var m={};function v(t){var n="function"==typeof Map?new Map:void 0;return((m=v=function(t){if(null===t||!f(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(t))return n.get(t);n.set(t,e)}function e(){return p(t,arguments,a(this).constructor)}return e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i(e,t)}).default=m).__esModule=!0,v(t)}((m=v).default=m).__esModule=!0;var y=u(c),g=function(e){function t(t){t=e.call(this,t)||this;return t.name="TimeoutError",t}return(0,y.default)(t,e),t}((0,u(m).default)(Error)),b=function(e){var n,t=new Promise(function(t){n=setTimeout(t,e)});return t.timeout=n,t},w={},_="object"==typeof Reflect?Reflect:null,x=_&&"function"==typeof _.apply?_.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)};var j=_&&"function"==typeof _.ownKeys?_.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)},P=Number.isNaN||function(t){return t!=t};function E(){E.init.call(this)}(w=E).once=function(a,u){return new Promise(function(t,e){function n(t){a.removeListener(u,r),e(t)}function r(){"function"==typeof a.removeListener&&a.removeListener("error",n),t([].slice.call(arguments))}var o,i,s;N(a,u,r,{once:!0}),"error"!==u&&(i=n,s={once:!0},"function"==typeof(o=a).on&&N(o,"error",i,s))})},(E.EventEmitter=E).prototype._events=void 0,E.prototype._eventsCount=0,E.prototype._maxListeners=void 0;var S=10;function O(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function L(t){return void 0===t._maxListeners?E.defaultMaxListeners:t._maxListeners}function k(t,e,n,r){var o,i;return O(n),void 0===(o=t._events)?(o=t._events=Object.create(null),t._eventsCount=0):(void 0!==o.newListener&&(t.emit("newListener",e,n.listener||n),o=t._events),i=o[e]),void 0===i?(i=o[e]=n,++t._eventsCount):("function"==typeof i?i=o[e]=r?[n,i]:[i,n]:r?i.unshift(n):i.push(n),0<(n=L(t))&&i.length>n&&!i.warned&&(i.warned=!0,(n=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",n.emitter=t,n.type=e,n.count=i.length,n=n,console&&console.warn&&console.warn(n))),t}function A(t,e,n){t={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},e=function(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}.bind(t);return e.listener=n,t.wrapFn=e}function M(t,e,n){t=t._events;if(void 0===t)return[];e=t[e];return void 0===e?[]:"function"==typeof e?n?[e.listener||e]:[e]:n?function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}(e):T(e,e.length)}function C(t){var e=this._events;if(void 0!==e){t=e[t];if("function"==typeof t)return 1;if(void 0!==t)return t.length}return 0}function T(t,e){for(var n=new Array(e),r=0;r<e;++r)n[r]=t[r];return n}function N(n,r,o,i){if("function"==typeof n.on)i.once?n.once(r,o):n.on(r,o);else{if("function"!=typeof n.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n);n.addEventListener(r,function t(e){i.once&&n.removeEventListener(r,t),o(e)})}}Object.defineProperty(E,"defaultMaxListeners",{enumerable:!0,get:function(){return S},set:function(t){if("number"!=typeof t||t<0||P(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");S=t}}),E.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},E.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||P(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},E.prototype.getMaxListeners=function(){return L(this)},E.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var r,o="error"===t,i=this._events;if(void 0!==i)o=o&&void 0===i.error;else if(!o)return!1;if(o){if((r=0<e.length?e[0]:r)instanceof Error)throw r;o=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw o.context=r,o}i=i[t];if(void 0===i)return!1;if("function"==typeof i)x(i,this,e);else for(var s=i.length,a=T(i,s),n=0;n<s;++n)x(a[n],this,e);return!0},E.prototype.addListener=function(t,e){return k(this,t,e,!1)},E.prototype.on=E.prototype.addListener,E.prototype.prependListener=function(t,e){return k(this,t,e,!0)},E.prototype.once=function(t,e){return O(e),this.on(t,A(this,t,e)),this},E.prototype.prependOnceListener=function(t,e){return O(e),this.prependListener(t,A(this,t,e)),this},E.prototype.removeListener=function(t,e){var n,r,o,i,s;if(O(e),void 0===(r=this._events))return this;if(void 0===(n=r[t]))return this;if(n===e||n.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete r[t],r.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(o=-1,i=n.length-1;0<=i;i--)if(n[i]===e||n[i].listener===e){s=n[i].listener,o=i;break}if(o<0)return this;0===o?n.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(n,o),1===n.length&&(r[t]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",t,s||e)}return this},E.prototype.off=E.prototype.removeListener,E.prototype.removeAllListeners=function(t){var e,n=this._events;if(void 0===n)return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[t]),this;if(0===arguments.length){for(var r,o=Object.keys(n),i=0;i<o.length;++i)"removeListener"!==(r=o[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(void 0!==e)for(i=e.length-1;0<=i;i--)this.removeListener(t,e[i]);return this},E.prototype.listeners=function(t){return M(this,t,!0)},E.prototype.rawListeners=function(t){return M(this,t,!1)},E.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):C.call(t,e)},E.prototype.listenerCount=C,E.prototype.eventNames=function(){return 0<this._eventsCount?j(this._events):[]};var R={};R.EventEmitter=w,R.timeout=function(t,e){var n=b(e);return Promise.race([t.finally(function(){clearTimeout(n.timeout)}),n.then(function(){throw new g})])},R.promise=function(s,a,u,c){return void 0===u&&(u="error"),new Promise(function(e,n){var t,r=function(){clearTimeout(t),s.removeListener(a,i),s.removeListener(u,o)};function o(t){n(t),r()}function i(t){e(t),r()}s.once(a,i),u&&s.once(u,o),c&&(t=setTimeout(function(){r(),n(new g)},c))})},R.Deferred=function(){var n=this;this.promise=new Promise(function(t,e){n.resolve=t,n.reject=e})};var X={detect:function(t){return!!t&&-1!==t.replace(/\\20/g,"").replace(/\\22/g,"").replace(/\\26/g,"").replace(/\\27/g,"").replace(/\\2f/g,"").replace(/\\3a/g,"").replace(/\\3c/g,"").replace(/\\3e/g,"").replace(/\\40/g,"").replace(/\\5c/g,"").search(/[ "&'/:<>@\\]/g)},escape:function(t){return null===t?null:t.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/"/g,"\\22").replace(/&/g,"\\26").replace(/'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40").replace(/\3a/g,"c3a")},unescape:function(t){return null===t?null:t.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")}},q=function(t){function e(t,e,n){if("string"!=typeof e||!e)throw new TypeError("Invalid domain.");this.setDomain(e),this.setLocal("string"==typeof t?t:""),this.setResource("string"==typeof n?n:"")}var n=e.prototype;return n[t]=function(t){return"number"===t?NaN:this.toString()},n.toString=function(t){var e=this._domain;return this._local&&(e=this.getLocal(t)+"@"+e),e=this._resource?e+"/"+this._resource:e},n.bare=function(){return this._resource?new e(this._local,this._domain,null):this},n.equals=function(t){return this._local===t._local&&this._domain===t._domain&&this._resource===t._resource},n.setLocal=function(t,e){return(e=e||X.detect(t))&&(t=X.escape(t)),this._local=t&&t.toLowerCase(),this},n.getLocal=function(t){return(t=void 0===t?!1:t)?X.unescape(this._local):this._local},n.setDomain=function(t){return this._domain=t.toLowerCase(),this},n.getDomain=function(){return this._domain},n.setResource=function(t){return this._resource=t,this},n.getResource=function(){return this._resource},e}(Symbol.toPrimitive);Object.defineProperty(q.prototype,"local",{get:q.prototype.getLocal,set:q.prototype.setLocal}),Object.defineProperty(q.prototype,"domain",{get:q.prototype.getDomain,set:q.prototype.setDomain}),Object.defineProperty(q.prototype,"resource",{get:q.prototype.getResource,set:q.prototype.setResource});var I=q,F=function(t){var e,n,r=t.indexOf("/");-1!==r&&(n=t.slice(r+1),t=t.slice(0,r));r=t.indexOf("@");return-1!==r&&(e=t.slice(0,r),t=t.slice(r+1)),new I(e,t,n)},z={},D=u(p);function B(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return e[1]||e[2]?(0,D.default)(I,e):F.apply(void 0,e)}(z=B.bind()).jid=B,z.JID=I,z.equal=function(t,e){return t.equals(e)},z.detectEscape=X.detect,z.escapeLocal=X.escape,z.unescapeLocal=X.unescape,z.parse=F;var U={};Object.defineProperty(U,"__esModule",{value:!0});var W={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};function $(t){return W[t]}var H={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};function K(t){if("#"===t[1]){var e="x"===t[2]?parseInt(t.slice(3),16):parseInt(t.slice(2),10);if(9===e||10===e||13===e||32<=e&&e<=55295||57344<=e&&e<=65533||65536<=e&&e<=1114111)return String.fromCodePoint(e);throw new Error("Illegal XML character 0x"+e.toString(16))}if(H[t])return H[t]||t;throw new Error("Illegal XML entity "+t)}function Y(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return J(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?J(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function J(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}U.escapeXML=function(t){return t.replace(/["&'<>]/g,$)},U.escapeXMLText=function(t){return t.replace(/[&<>]/g,$)},U.unescapeXML=function(t){for(var e,n="",r=-1,o=0;-1!==(e=t.indexOf("&",o))&&-1!==(r=t.indexOf(";",e+1));)n=n+t.slice(o,e)+K(t.slice(e,r+1)),o=r+1;return 0===o?t:n+=t.substring(o)},U.unescapeXMLText=function(t){return t.replace(/&(amp|#38|lt|#60|gt|#62);/g,K)};var G=function(){function n(t,e){this.name=t,this.parent=null,this.children=[],this.attrs={},this.setAttrs(e)}var t=n.prototype;return t.is=function(t,e){return this.getName()===t&&(!e||this.getNS()===e)},t.getName=function(){var t=this.name.indexOf(":");return 0<=t?this.name.slice(t+1):this.name},t.getNS=function(){var t=this.name.indexOf(":");if(0<=t){t=this.name.slice(0,t);return this.findNS(t)}return this.findNS()},t.findNS=function(t){if(t){var e="xmlns:"+t;return this.attrs[e]?this.attrs[e]:this.parent?this.parent.findNS(t):void 0}return this.attrs.xmlns||(this.parent?this.parent.findNS():void 0)},t.getXmlns=function(){var t,e={};for(t in this.parent&&(e=this.parent.getXmlns()),this.attrs){var n=t.match("xmlns:?(.*)");this.attrs.hasOwnProperty(t)&&n&&(e[this.attrs[t]]=n[1])}return e},t.setAttrs=function(t){"string"==typeof t?this.attrs.xmlns=t:t&&Object.assign(this.attrs,t)},t.getAttr=function(t,e){if(!e)return this.attrs[t];var n=this.getXmlns();return n[e]?this.attrs[[n[e],t].join(":")]:null},t.getChild=function(t,e){return this.getChildren(t,e)[0]},t.getChildren=function(t,e){for(var n=[],r=Y(this.children);!(o=r()).done;){var o=o.value;!o.getName||o.getName()!==t||e&&o.getNS()!==e||n.push(o)}return n},t.getChildByAttr=function(t,e,n,r){return this.getChildrenByAttr(t,e,n,r)[0]},t.getChildrenByAttr=function(t,e,n,r){for(var o=[],i=Y(this.children);!(s=i()).done;){var s=s.value;!s.attrs||s.attrs[t]!==e||n&&s.getNS()!==n||o.push(s),r&&s.getChildrenByAttr&&o.push(s.getChildrenByAttr(t,e,n,!0))}return o=r?o.flat():o},t.getChildrenByFilter=function(t,e){for(var n=[],r=Y(this.children);!(o=r()).done;){var o=o.value;t(o)&&n.push(o),e&&o.getChildrenByFilter&&n.push(o.getChildrenByFilter(t,!0))}return n=e?n.flat():n},t.getText=function(){for(var t="",e=Y(this.children);!(n=e()).done;){var n=n.value;"string"!=typeof n&&"number"!=typeof n||(t+=n)}return t},t.getChildText=function(t,e){e=this.getChild(t,e);return e?e.getText():null},t.getChildElements=function(){return this.getChildrenByFilter(function(t){return t instanceof n})},t.root=function(){return this.parent?this.parent.root():this},t.up=function(){return this.parent||this},t.c=function(t,e){return this.cnode(new n(t,e))},t.cnode=function(t){return this.children.push(t),"object"==typeof t&&(t.parent=this),t},t.append=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var r=0,o=e;r<o.length;r++){var i=o[r];this.children.push(i),"object"==typeof i&&(i.parent=this)}},t.prepend=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var r=0,o=e;r<o.length;r++){var i=o[r];this.children.unshift(i),"object"==typeof i&&(i.parent=this)}},t.t=function(t){return this.children.push(t),this},t.remove=function(e,n){return this.children=this.children.filter("string"==typeof e?function(t){return!(t.is&&t.is(e,n))}:function(t){return t!==e}),this},t.text=function(t){return t&&1===this.children.length?(this.children[0]=t,this):this.getText()},t.attr=function(t,e){return void 0!==e||null===e?(this.attrs||(this.attrs={}),this.attrs[t]=e,this):this.attrs[t]},t.toString=function(){var e="";return this.write(function(t){e+=t}),e},t._addChildren=function(t){t(">");for(var e=Y(this.children);!(n=e()).done;){var n=n.value;null!=n&&(n.write?n.write(t):"string"==typeof n?t(U.escapeXMLText(n)):n.toString&&t(U.escapeXMLText(n.toString(10))))}t("</"),t(this.name),t(">")},t.write=function(t){for(var e in t("<"),t(this.name),this.attrs){var n=this.attrs[e];null!=n&&(t(" "),t(e),t('="'),t(U.escapeXML("string"==typeof n?n:n.toString(10))),t('"'))}0===this.children.length?t("/>"):this._addChildren(t)},n}();G.prototype.tree=G.prototype.root;var Q=G;function V(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return Z(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Z(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Z(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var tt=function(t,e){if("object"==typeof e&&null!==e){delete e.__source,delete e.__self;for(var n=0,r=Object.entries(e);n<r.length;n++){var o=r[n],i=o[0],o=o[1];null==o?delete e[i]:e[i]=o.toString(10)}}for(var s=new Q(t,e),a=arguments.length,u=new Array(2<a?a-2:0),c=2;c<a;c++)u[c-2]=arguments[c];for(var l=0,f=u;l<f.length;l++)!function t(e,n){if(Array.isArray(n))for(var r,o=V(n);!(r=o()).done;)t(e,r.value);else""!==n&&null!=n&&!0!==n&&!1!==n&&e.cnode(n)}(s,f[l]);return s},t={};((t=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}).default=t).__esModule=!0;var et=u(c),nt=function(e){function t(){var c,l,f,h,p,d,m,v,y,t=e.call(this)||this,g=0,b=0;return t._handleTagOpening=function(t,e,n){t?this.emit("endElement",e):(this.emit("startElement",e,n),d&&this.emit("endElement",e))},t.write=function(e){"string"!=typeof e&&(e=e.toString());var n=0;function t(){if("number"==typeof b){var t=e.slice(b,n);return b=void 0,t}}for(c&&(e=c+e,n+=l?0:c.length,l=!1,c=null);n<e.length;n++){switch(g){case 0:var r=e.indexOf("<",n);-1!==r&&n!==r&&(n=r);break;case 8:r=e.indexOf(v,n);-1!==r&&(n=r);break;case 1:var o=e.indexOf("--\x3e",n);-1!==o&&(n=o+2);break;case 10:o=e.indexOf("]]>",n);-1!==o&&(n=o+2)}var i,s,a,u=e.charCodeAt(n);switch(g){case 0:60===u&&((i=t())&&this.emit("text",U.unescapeXML(i)),g=3,b=n+1,h={});break;case 9:93===u&&("]>"===e.substr(n+1,2)?((s=t())&&this.emit("text",s),g=0):e.length<n+2&&(l=!0,n=e.length));break;case 3:47===u&&b===n?(b=n+1,p=!0):33===u?"[CDATA["===e.substr(n+1,7)?(b=n+8,g=9):e.length<n+8&&"[CDATA[".startsWith(e.slice(n+1))?(l=!0,n=e.length):(b=void 0,g=1):63===u?(b=void 0,g=2):(u<=32||47===u||62===u)&&(f=t(),n--,g=4);break;case 1:62===u&&(s=e.charCodeAt(n-1),a=e.charCodeAt(n-2),(45===s&&45===a||93===s&&93===a)&&(g=0));break;case 2:62===u&&63===e.charCodeAt(n-1)&&(g=0);break;case 4:62===u?(this._handleTagOpening(p,f,h),d=p=h=f=void 0,g=0,b=n+1):47===u?d=!0:32<u&&(b=n,g=5);break;case 5:(u<=32||61===u)&&(y=t(),n--,g=6);break;case 6:61===u&&(g=7);break;case 7:34!==u&&39!==u||(v=34===(m=u)?'"':"'",g=8,b=n+1);break;case 8:u===m&&(a=U.unescapeXML(t()),h[y]=a,y=void 0,g=4)}}"number"==typeof b&&b<=e.length&&(c=e.slice(b),b=0)},t}return(0,et.default)(t,e),t.prototype.end=function(t){t&&this.write(t),this.write=function(){}},t}(w.EventEmitter),rt=u(c),ot=function(o){function t(){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return(t=o.call.apply(o,[this].concat(n))||this).name="XMLError",t}return(0,rt.default)(t,o),t}((0,u(m).default)(Error)),it=u(t),st=u(c),_=function(n){function t(){var t=n.call(this)||this,e=new nt;return t.root=null,t.cursor=null,e.on("startElement",t.onStartElement.bind((0,it.default)(t))),e.on("endElement",t.onEndElement.bind((0,it.default)(t))),e.on("text",t.onText.bind((0,it.default)(t))),t.parser=e,t}(0,st.default)(t,n);var e=t.prototype;return e.onStartElement=function(t,e){var n=new Q(t,e),t=this.root,e=this.cursor;t?e!==t&&e.append(n):(this.root=n,this.emit("start",n)),this.cursor=n},e.onEndElement=function(t){var e=this.root,n=this.cursor;if(t===n.name){if(n!==e)return n.parent?void(this.cursor=n.parent):(n.parent=e,this.emit("element",n),void(this.cursor=e));this.emit("end",e)}else this.emit("error",new ot(n.name+" must be closed."))},e.onText=function(t){var e=this.cursor;e?e.t(t):this.emit("error",new ot(t+" must be a child."))},e.write=function(t){this.parser.write(t)},e.end=function(t){t&&this.parser.write(t)},t}(w);_.XMLError=ot;var at=_,ut={},q=U.escapeXML,G=U.unescapeXML,t=U.escapeXMLText,_=U.unescapeXMLText;ut=function(){return tt.apply(void 0,arguments)},Object.assign(ut,{Element:Q,createElement:tt,Parser:at,escapeXML:q,unescapeXML:G,escapeXMLText:t,unescapeXMLText:_,XMLError:ot});var ct=u(c),q=function(o){function t(t,e,n){var r=o.call(this,t+(e?" - "+e:""))||this;return r.name="XMPPError",r.condition=t,r.text=e,r.application=n,r}return(0,ct.default)(t,o),t.fromElement=function(t){var e,n=t.children,r=n[0],o=n[1],n=n[2];o&&(o.is("text")?e=o:o&&(i=o),n&&(i=n));var i=new this(r.name,e?e.text():"",i);return i.element=t,i},t}((0,u(m).default)(Error)),lt=u(c),ft=function(o){function t(){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return(t=o.call.apply(o,[this].concat(n))||this).name="StreamError",t}return(0,lt.default)(t,o),t}(q),G={};function ht(t){var e=new URL(t),n=e.port,t=e.hostname;return{port:n,hostname:t="[::1]"===t?"::1":t,protocol:e.protocol}}function pt(t){t=ht("http://"+t);return{port:t.port,hostname:t.hostname}}Object.assign(G,{parseURI:ht,parseHost:pt,parseService:function(t){return(t.includes("://")?ht:pt)(t)}});var dt=u(c);function mt(t,e,n){return n?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}function vt(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return yt(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?yt(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function yt(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function gt(){}var t=R.EventEmitter,bt=R.promise;function wt(t,e){if(!e)return t&&t.then?t.then(gt):Promise.resolve()}function _t(t,e){try{var n=t()}catch(t){return e(t)}return n&&n.then?n.then(void 0,e):n}function xt(t,e){return t&&t.then?t.then(e):e(t)}var jt=G.parseHost,Pt=G.parseService,_=function(n){function t(t){var e;return void 0===t&&(t={}),(e=n.call(this)||this).jid=null,e.timeout=2e3,e.options=t,e.socketListeners=Object.create(null),e.parserListeners=Object.create(null),e.status="offline",e.socket=null,e.parser=null,e.root=null,e}(0,dt.default)(t,n);var e=t.prototype;return e._reset=function(){this.jid=null,this.status="offline",this._detachSocket(),this._detachParser()},e._streamError=function(t,e){try{var n=this;return xt(_t(function(){return wt(n.send(ut("stream:error",{},[ut(t,{xmlns:"urn:ietf:params:xml:ns:xmpp-streams"},e)])))},gt),function(){return n._end()})}catch(t){return Promise.reject(t)}},e._onData=function(t){t=t.toString("utf8");this.emit("input",t),this.parser.write(t)},e._onParserError=function(t){this._streamError("bad-format"),this._detachParser(),this.emit("error",t)},e._attachSocket=function(t){var n=this;this.socket=t;t=this.socketListeners;t.data=this._onData.bind(this),t.close=function(t,e){n._reset(),n._status("disconnect",{clean:!t,event:e})},t.connect=function(){n._status("connect")},t.error=function(t){n.emit("error",t)},this.socket.on("close",t.close),this.socket.on("data",t.data),this.socket.on("error",t.error),this.socket.on("connect",t.connect)},e._detachSocket=function(){for(var t=this.socketListeners,e=this.socket,n=vt(Object.getOwnPropertyNames(t));!(r=n()).done;){var r=r.value;e.removeListener(r,t[r]),delete t[r]}return this.socket=null,e},e._onElement=function(t){var e=t.is("error","http://etherx.jabber.org/streams");e&&this._onStreamError(t),this.emit("element",t),this.emit(this.isStanza(t)?"stanza":"nonza",t),e&&this._end()},e._onStreamError=function(t){t=ft.fromElement(t);if("see-other-host"===t.condition)return this._onSeeOtherHost(t);this.emit("error",t)},e._onSeeOtherHost=function(t){try{var r=this,e=Pt(r.options.service).protocol,n=t.element.getChildText("see-other-host"),o=jt(n).port?(e||"xmpp:")+"//"+n:(e?e+"//":"")+n;return function(t){if(t&&t.then)return t.then(gt)}(_t(function(){return mt(bt(r,"disconnect"),function(){var t=r.options,e=t.domain,n=t.lang;return mt(r.connect(o),function(){return wt(r.open({domain:e,lang:n}))})})},function(t){r.emit("error",t)}))}catch(t){return Promise.reject(t)}},e._attachParser=function(t){var e=this;this.parser=t;t=this.parserListeners;t.element=this._onElement.bind(this),t.error=this._onParserError.bind(this),t.end=function(t){e._detachParser(),e._status("close",t)},t.start=function(t){e._status("open",t)},this.parser.on("error",t.error),this.parser.on("element",t.element),this.parser.on("end",t.end),this.parser.on("start",t.start)},e._detachParser=function(){for(var t=this.parserListeners,e=vt(Object.getOwnPropertyNames(t));!(n=e()).done;){var n=n.value;this.parser.removeListener(n,t[n]),delete t[n]}this.parser=null},e._jid=function(t){return this.jid=z(t),this.jid},e._status=function(t){this.status=t;for(var e=arguments.length,n=new Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];this.emit.apply(this,["status",t].concat(n)),this.emit.apply(this,[t].concat(n))},e._end=function(){try{var e,t=this;return xt(_t(function(){return mt(t.close(),function(t){e=t})},gt),function(){return xt(_t(function(){return wt(t.disconnect())},gt),function(){return e})})}catch(t){return Promise.reject(t)}},e.start=function(){try{var e=this;if("offline"!==e.status)throw new Error("Connection is not offline");var t=e.options,n=t.service,r=t.domain,o=t.lang;return mt(e.connect(n),function(){var t=bt(e,"online");return mt(e.open({domain:r,lang:o}),function(){return t})})}catch(t){return Promise.reject(t)}},e.connect=function(t){try{this._status("connecting",t);var e=new this.Socket;return this._attachSocket(e),e.connect(this.socketParameters(t)),bt(e,"connect")}catch(t){return Promise.reject(t)}},e.disconnect=function(t){try{var e=this;return void 0===t&&(t=e.timeout),e.socket&&e._status("disconnecting"),e.socket.end(),wt(bt(e.socket,"close","error",t))}catch(t){return Promise.reject(t)}},e.open=function(t){try{var e=this;e._status("opening");var n=t="string"==typeof t?{domain:t}:t,r=n.domain,o=n.lang,i=n.timeout,s=void 0===i?e.timeout:i,a=e.headerElement();return a.attrs.to=r,a.attrs["xml:lang"]=o,e.root=a,e._attachParser(new e.Parser),mt(e.write(e.header(a)),function(){return bt(e,"open","error",s)})}catch(t){return Promise.reject(t)}},e.stop=function(){try{var e=this;return mt(e._end(),function(t){return"offline"!==e.status&&e._status("offline",t),t})}catch(t){return Promise.reject(t)}},e.close=function(t){try{var e=this;void 0===t&&(t=e.timeout);var n=e.footer(e.footerElement()),r=Promise.all([bt(e.parser,"end","error",t),e.write(n)]);return e.parser&&e.socket&&e._status("closing"),mt(r,function(t){t=t[0];return e.root=null,t})}catch(t){return Promise.reject(t)}},e.restart=function(){try{this._detachParser();var t=this.options,e=t.domain,n=t.lang;return this.open({domain:e,lang:n})}catch(t){return Promise.reject(t)}},e.send=function(t){try{var e=this;return t.parent=e.root,mt(e.write(t.toString()),function(){e.emit("send",t)})}catch(t){return Promise.reject(t)}},e.sendReceive=function(t,e){return void 0===e&&(e=this.timeout),Promise.all([this.send(t),bt(this,"element","error",e)]).then(function(t){return t[1]})},e.write=function(r){var o=this;return new Promise(function(e,n){"closing"!==o.status?o.socket.write(r,function(t){return t?n(t):(o.emit("output",r),void e())}):n(new Error("Connection is closing"))})},e.isStanza=function(t){t=t.name;return"iq"===t||"message"===t||"presence"===t},e.isNonza=function(t){return!this.isStanza(t)},e.header=function(t){return t.toString()},e.headerElement=function(){return new ut.Element("",{version:"1.0",xmlns:this.NS})},e.footer=function(t){return t.toString()},e.footerElement=function(){},e.socketParameters=function(){},t}(t);_.prototype.NS="",_.prototype.Socket=null,_.prototype.Parser=null;var G=_,Et=u(c),t=function(n){function t(t){t=n.call(this,t)||this;return t.transports=[],t}(0,Et.default)(t,n);var e=t.prototype;return e.send=function(t){for(var e,n=arguments.length,r=new Array(1<n?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return(e=this.Transport.prototype.send).call.apply(e,[this,t].concat(r))},e.sendMany=function(){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return(t=this.Transport.prototype.sendMany).call.apply(t,[this].concat(n))},e._findTransport=function(e){return this.transports.find(function(t){try{return void 0!==t.prototype.socketParameters(e)}catch(t){return!1}})},e.connect=function(t){var e=this._findTransport(t);if(!e)throw new Error("No compatible connection method found.");return this.Transport=e,this.Socket=e.prototype.Socket,this.Parser=e.prototype.Parser,n.prototype.connect.call(this,t)},e.socketParameters=function(){var t;return(t=this.Transport.prototype).socketParameters.apply(t,arguments)},e.header=function(){var t;return(t=this.Transport.prototype).header.apply(t,arguments)},e.headerElement=function(){var t;return(t=this.Transport.prototype).headerElement.apply(t,arguments)},e.footer=function(){var t;return(t=this.Transport.prototype).footer.apply(t,arguments)},e.footerElement=function(){var t;return(t=this.Transport.prototype).footerElement.apply(t,arguments)},t}(G);t.prototype.NS="jabber:client";_={};_.Client=t,_.xml=ut,_.jid=z;var St=function(t){return(t.split("://")[1]||t).split(":")[0].split("/")[0]},Ot=u(c);function Lt(){}var kt=function(n){function t(t){var e=n.call(this)||this;return e.delay=1e3,e.entity=t,e._timeout=null,e}(0,Ot.default)(t,n);var e=t.prototype;return e.scheduleReconnect=function(){var n,t=this,e=this.entity,r=this.delay,o=this._timeout;clearTimeout(o),this._timeout=setTimeout((n=function(){if("disconnect"===e.status)return function(t){if(t&&t.then)return t.then(Lt)}(function(t,e){try{var n=t()}catch(t){return e(t)}if(n&&n.then)return n.then(void 0,e);return n}(function(){return function(t,e){if(!e)return t&&t.then?t.then(Lt):Promise.resolve()}(t.reconnect())},Lt))},function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(n.apply(this,t))}catch(t){return Promise.reject(t)}}),r)},e.reconnect=function(){try{var t=this,e=t.entity;t.emit("reconnecting");var n=e.options,r=n.service,o=n.domain,i=n.lang;return At(e.connect(r),function(){return At(e.open({domain:o,lang:i}),function(){t.emit("reconnected")})})}catch(t){return Promise.reject(t)}},e.start=function(){var t=this,e=this.entity,n={disconnect:function(){t.scheduleReconnect()}};this.listeners=n,e.on("disconnect",n.disconnect)},e.stop=function(){var t=this.entity,e=this.listeners,n=this._timeout;t.removeListener("disconnect",e.disconnect),clearTimeout(n)},t}(R.EventEmitter);function At(t,e,n){return n?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var Mt=function(t){t=t.entity,t=new kt(t);return t.start(),t},Ct={},Tt={};!function(t){!function(){"use strict";var r=u(c);function o(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return i(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var s=t.WebSocket||Ct,a="ECONNERROR";Tt=function(e){function t(){var t=e.call(this)||this;return t.listeners=Object.create(null),t}(0,r.default)(t,e);var n=t.prototype;return n.connect=function(t){this.url=t,this._attachSocket(new s(t,["xmpp"]))},n._attachSocket=function(t){var r=this;this.socket=t;t=this.listeners;t.open=function(){r.emit("connect")},t.message=function(t){t=t.data;return r.emit("data",t)},t.error=function(t){var e=r.url,n=t.error;n||((n=new Error("WebSocket "+a+" "+e)).errno=a,n.code=a),n.event=t,n.url=e,r.emit("error",n)},t.close=function(t){r._detachSocket(),r.emit("close",!t.wasClean,t)},this.socket.addEventListener("open",t.open),this.socket.addEventListener("message",t.message),this.socket.addEventListener("error",t.error),this.socket.addEventListener("close",t.close)},n._detachSocket=function(){delete this.url;for(var t=this.socket,e=this.listeners,n=o(Object.getOwnPropertyNames(e));!(r=n()).done;){var r=r.value;t.removeEventListener(r,e[r]),delete e[r]}delete this.socket},n.end=function(){this.socket.close()},n.write=function(t,e){s===Ct?this.socket.send(t,e):(this.socket.send(t),e())},t}(w)}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var Nt=u(c),t=ut.Parser,Rt=ut.Element,Xt=ut.XMLError,t=function(t){function e(){return t.apply(this,arguments)||this}(0,Nt.default)(e,t);var n=e.prototype;return n.onStartElement=function(t,e){t=new Rt(t,e),e=this.cursor;e&&e.append(t),this.cursor=t},n.onEndElement=function(t){var e=this.cursor;t===e.name?e.parent?this.cursor=e.parent:(e.is("open","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("start",e):e.is("close","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("end",e):this.emit("element",e),this.cursor=null):this.emit("error",new Xt(e.name+" must be closed."))},e}(t),qt=u(c);function It(){}var Ft="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function zt(t,e,n){if(!t.s){if(n instanceof Dt){if(!n.s)return void(n.o=zt.bind(null,t,e));1&e&&(e=n.s),n=n.v}n&&n.then?n.then(zt.bind(null,t,e),zt.bind(null,t,2)):(t.s=e,t.v=n,(n=t.o)&&n(t))}}var Dt=function(){function e(){}return e.prototype.then=function(n,r){var o=new e,t=this.s;if(t){t=1&t?n:r;if(t){try{zt(o,1,t(this.v))}catch(t){zt(o,2,t)}return o}return this}return this.o=function(t){try{var e=t.v;1&t.s?zt(o,1,n?n(e):e):r?zt(o,1,r(e)):zt(o,2,e)}catch(t){zt(o,2,t)}},o},e}();function Bt(t){return t instanceof Dt&&1&t.s}function Ut(n,r,o){var i,s,a=-1;return function t(e){try{for(;++a<n.length&&(!o||!o());)if((e=r(a))&&e.then){if(!Bt(e))return void e.then(t,s=s||zt.bind(null,i=new Dt,2));e=e.v}i?zt(i,1,e):i=e}catch(t){zt(i=i||new Dt,2,t)}}(),i}function Wt(t,e,n){if("function"==typeof t[Ft]){function r(t){try{for(;!((o=a.next()).done||n&&n());)if((t=e(o.value))&&t.then){if(!Bt(t))return void t.then(r,s=s||zt.bind(null,i=new Dt,2));t=t.v}i?zt(i,1,t):i=t}catch(t){zt(i=i||new Dt,2,t)}}var o,i,s,a=t[Ft]();if(r(),a.return){function u(t){try{o.done||a.return()}catch(t){}return t}if(i&&i.then)return i.then(u,function(t){throw u(t)});u()}return i}if(!("length"in t))throw new TypeError("Object is not iterable");for(var c=[],l=0;l<t.length;l++)c.push(t[l]);return Ut(c,function(t){return e(c[t])},n)}var $t="urn:ietf:params:xml:ns:xmpp-framing",G=function(i){function t(){return i.apply(this,arguments)||this}(0,qt.default)(t,i);var e=t.prototype;return e.send=function(t){var e;!t.attrs.xmlns&&i.prototype.isStanza.call(this,t)&&(t.attrs.xmlns="jabber:client");for(var n=arguments.length,r=new Array(1<n?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return(e=i.prototype.send).call.apply(e,[this,t].concat(r))},e.sendMany=function(t){try{var e=this;return function(t){if(t&&t.then)return t.then(It)}(Wt(t,function(t){return function(t,e){if(!e)return t&&t.then?t.then(It):Promise.resolve()}(e.send(t))}))}catch(t){return Promise.reject(t)}},e.footerElement=function(){return new ut.Element("close",{xmlns:$t})},e.headerElement=function(){var t=i.prototype.headerElement.call(this);return t.name="open",t.attrs.xmlns=$t,t},e.socketParameters=function(t){return/^wss?:\/\//.test(t)?t:void 0},t}(G);G.prototype.Socket=Tt,G.prototype.NS="jabber:client",G.prototype.Parser=t;var Ht=G,Kt=function(t){t.entity.transports.push(Ht)};function Yt(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return Jt(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Jt(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Jt(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var Gt=function(s){if(!Array.isArray(s))throw new TypeError("Middleware stack must be an array!");for(var t,e=Yt(s);!(t=e()).done;)if("function"!=typeof t.value)throw new TypeError("Middleware must be composed of functions!");return function(n,r){var o=-1;return i(0);function i(t){if(t<=o)return Promise.reject(new Error("next() called multiple times"));var e=s[o=t];if(!(e=t===s.length?r:e))return Promise.resolve();try{return Promise.resolve(e(n,i.bind(null,t+1)))}catch(t){return Promise.reject(t)}}}};var G=function(t,e){this.stanza=e,this.entity=t;var n=e.name,t=e.attrs,e=t.type,t=t.id;this.name=n,this.id=t||"",this.type="message"===n?e||"normal":"presence"===n?e||"available":e||"",this.from=null,this.to=null,this.local="",this.domain="",this.resource=""},Qt=u(c),Vt=function(o){function t(t,e){var n=o.call(this,t,e)||this,r=t.jid,t=t.domain,r=e.attrs.to||r&&r.toString(),t=e.attrs.from||t;return r&&(n.to=new z(r)),t&&(n.from=new z(t),n.local=n.from.local,n.domain=n.from.domain,n.resource=n.from.resource),n}return(0,Qt.default)(t,o),t}(G),Zt=u(c),te=function(o){function t(t,e){var n=o.call(this,t,e)||this,r=t.jid,t=t.domain,r=e.attrs.from||r&&r.toString(),t=e.attrs.to||t;return r&&(n.from=new z(r)),t&&(n.to=new z(t),n.local=n.to.local,n.domain=n.to.domain,n.resource=n.to.resource),n}return(0,Zt.default)(t,o),t}(G);function ee(e,n,r){return function(t){t=new r(e,t);return Gt(n)(t)}}var ne=function(t){var n,e=t.entity,r=[function(t,e){e().then(function(t){return t&&n.send(t)}).catch(function(t){return n.emit("error",t)})}],o=[],i=ee(n=e,r,Vt),t=ee(e,o,te);return e.on("element",i),e.hookOutgoing=t,{use:function(t){return r.push(t),t},filter:function(t){return o.push(t),t}}};var re=function(){return n=function(t,e){var n=t.stanza,r=t.entity;return n.is("features","http://etherx.jabber.org/streams")?function(t,e,n){if(n)return e?e(t()):t();try{var r=Promise.resolve(t());return e?r.then(e):r}catch(t){return Promise.reject(t)}}(e,function(t){!t&&r.jid&&r._status("online",r.jid)}):e()},function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(n.apply(this,t))}catch(t){return Promise.reject(t)}};var n},oe=function(t){var e=t.middleware;return e.use(re()),{use:function(r,o,i){return e.use(function(t,e){var n=t.stanza;if(!n.is("features","http://etherx.jabber.org/streams"))return e();n=n.getChild(r,o);return n?i(t,e,n):e()})}}},ie=u(c),se=function(o){function t(t,e,n,r){n=o.call(this,t,e,n)||this;return n.type=r,n.name="StanzaError",n}return(0,ie.default)(t,o),t.fromElement=function(t){var e=o.fromElement.call(this,t);return e.type=t.attrs.type,e},t}(q),ae=u(p);function ue(){}var ce=R.Deferred;var le=R.timeout;var fe=function(){function t(t){var e=t.entity,t=t.middleware;this.handlers=new Map,this.entity=e,this.middleware=t}var e=t.prototype;return e.start=function(){this.middleware.use(this._route.bind(this))},e._route=function(t,e){var n=t.type,r=t.name,o=t.id,i=t.stanza;if(r=(t={name:r,type:n}).name,t=t.type,"iq"!==r||"error"!==t&&"result"!==t)return e();t=this.handlers.get(o);if(!t)return e();"error"===n?t.reject(se.fromElement(i.getChild("error"))):t.resolve(i),this.handlers.delete(o)},e.request=function(r,o){void 0===o&&(o=3e4);try{var i=this;r.attrs.id||(r.attrs.id=function(){for(var t;!t;)t=Math.random().toString(36).slice(2,12);return t}());var s=new ce;return i.handlers.set(r.attrs.id,s),t=function(t,e){try{var n=t()}catch(t){return e(t)}return n&&n.then?n.then(void 0,e):n}(function(){return t=i.entity.send(r),e=function(){return function(t,e){if(!e)return t&&t.then?t.then(ue):Promise.resolve()}(le(s.promise,o))},n?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t);var t,e,n},function(t){throw i.handlers.delete(r.attrs.id),t}),e=function(t){return s.promise},t&&t.then?t.then(e):e(t)}catch(t){return Promise.reject(t)}var t,e},e._childRequest=function(t,e,n){for(var r=e.name,o=e.attrs.xmlns,i=arguments.length,s=new Array(3<i?i-3:0),a=3;a<i;a++)s[a-3]=arguments[a];return this.request.apply(this,[ut("iq",{type:t,to:n},e)].concat(s)).then(function(t){return t.getChild(r,o)})},e.get=function(){try{for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this._childRequest.apply(this,["get"].concat(e))}catch(t){return Promise.reject(t)}},e.set=function(){try{for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this._childRequest.apply(this,["set"].concat(e))}catch(t){return Promise.reject(t)}},t}(),he=function(){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return(t=(0,ae.default)(fe,n)).start(),t};var pe="urn:ietf:params:xml:ns:xmpp-stanzas";function de(t){t=t.stanza;return ut("iq",{to:t.attrs.from,from:t.attrs.to,id:t.attrs.id})}function me(t,e,n){t=de(t);return t.attrs.type="error",n&&t.append(n),t.append(e),t}function ve(t,e){return ut("error",{type:t},ut(e,pe))}function ye(h){return function(n,t){try{if(f=(l=n).name,l=l.type,"iq"!==f||("error"===l||"result"===l))return t();var r,e=n.stanza.getChildElements(),o=e[0];return(u=e,c=o,"get"!==(a=(a=n).type)&&"set"!==a||(1!==u.length||!c))?me(n,ve("modify","bad-request"),o):(n.element=o,i=function(t,e){try{var n=t()}catch(t){return e(t)}return n&&n.then?n.then(void 0,e):n}(function(){return function(t,e,n){if(n)return e?e(t()):t();try{var r=Promise.resolve(t());return e?r.then(e):r}catch(t){return Promise.reject(t)}}(t,function(t){r=t})},function(t){h.emit("error",t),r=ve("cancel","internal-server-error")}),s=function(){return(r=r||ve("cancel","service-unavailable"))instanceof ut.Element&&r.is("error")?me(n,r,o):(t=n,e=r instanceof ut.Element?r:void 0,(t=de(t)).attrs.type="result",e&&t.append(e),t);var t,e},i&&i.then?i.then(s):s(i))}catch(t){return Promise.reject(t)}var i,s,a,u,c,l,f}}function ge(n,r,o,i){return function(t,e){return t.type!==n|!t.element||!t.element.is(o,r)?e():i(t,e)}}var be=function(t){var r=t.middleware,t=t.entity;return r.use(ye(t)),{get:function(t,e,n){r.use(ge("get",t,e,n))},set:function(t,e,n){r.use(ge("set",t,e,n))}}},we={};function _e(t){return t.startsWith("https")||t.startsWith("wss")}we.compare=function(t,e){var n=_e(t.uri)&&!_e(e.uri)?-1:!_e(t.uri)&&_e(e.uri)?1:0;return 0!==n?n:0!==(e=t.method===e.method?0:"websocket"===t.method?-1:"websocket"===e.method?1:"xbosh"===t.method?-1:"xbosh"===e.method?1:"httppoll"===t.method?-1:"httppoll"===e.method?1:0)?e:0};var xe={};!function(t){!function(){"use strict";var e=t.fetch||Ct,n=we.compare;xe.resolve=function(t){return e("https://"+t+"/.well-known/host-meta").then(function(t){return t.text()}).then(function(t){return function(t){var e=new at,n=null,r=null;if(e.on("start",function(t){n=t}),e.on("element",function(t){n.append(t)}),e.on("error",function(t){r=t}),e.write(t),e.end(),r)throw r;return n}(t).getChildren("Link").filter(function(t){return["urn:xmpp:alt-connections:websocket","urn:xmpp:alt-connections:httppoll","urn:xmpp:alt-connections:xbosh"].includes(t.attrs.rel)}).map(function(t){t=t.attrs;return{rel:t.rel,href:t.href,method:t.rel.split(":").pop(),uri:t.href}}).sort(n)}).catch(function(){return[]})}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var je;function Pe(){}je=function(){return Promise.all([Ct.resolve?Ct.resolve.apply(Ct,arguments):Promise.resolve([]),xe.resolve.apply(xe,arguments)]).then(function(t){var e=t[0],t=t[1];return[].concat(e,t)})},Ct.resolve&&(je.dns=Ct),je.http=xe;var Ee=Me(function(e,t){var n=!1;if(0===t.length)throw new Error("Couldn't connect");var r=t.shift(),o=e._findTransport(r);if(!o)return Ee(e,t);e._status("connecting",r);var i,s=o.prototype.socketParameters(r),a=new o.prototype.Socket;return i=Le(function(){return a.connect(s),Se(Ae(a,"connect"))},function(){return n=!0,Ee(e,t)}),r=function(t){return n?t:(e._attachSocket(a),a.emit("connect"),e.Transport=o,e.Socket=o.prototype.Socket,void(e.Parser=o.prototype.Parser))},i&&i.then?i.then(r):r(i)});function Se(t,e){if(!e)return t&&t.then?t.then(Pe):Promise.resolve()}var Oe=Me(function(t){return ke(je(t,{srv:[{service:"xmpps-client",protocol:"tcp"},{service:"xmpp-client",protocol:"tcp"}]}),function(t){return[].concat(new Set(t.map(function(t){return t.uri})))})});function Le(t,e){try{var n=t()}catch(t){return e(t)}return n&&n.then?n.then(void 0,e):n}function ke(t,e,n){return n?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var Ae=R.promise;function Me(n){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(n.apply(this,t))}catch(t){return Promise.reject(t)}}}var Ce=function(t){var r=t.entity,e=r.connect;r.connect=function(t){try{return!t||/:\/\//.test(t)?e.call(this,t):ke(Oe(t),function(t){var e,n=(e=r,t.filter(function(t){return e._findTransport(t)}));if(0===n.length)throw new Error("No compatible transport found.");return Le(function(){return Se(Ee(r,n))},function(t){throw r._reset(),r._status("disconnect"),t})})}catch(t){return Promise.reject(t)}}},Te={};((Te=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}).default=Te).__esModule=!0;var Ne={};!function(e){!function(){"use strict";Ne.encode=function(t){return e.btoa(t)},Ne.decode=function(t){return e.atob(t)}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var Re=u(c),Xe=function(o){function t(){for(var t,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return(t=o.call.apply(o,[this].concat(n))||this).name="SASLError",t}return(0,Re.default)(t,o),t}(q);function qe(e,t){var n,r=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)),r}function Ie(){}q=function(t,e,n){(e.exports=n).Factory=n},"object"==typeof(Fe={exports:{}}).exports&&q(Fe.exports,Fe,r({}));var Fe=Fe.exports,ze=We(function(t,o,e,n){var i=t.create([e]);if(!i)throw new Error("No compatible mechanism");var e=o.options.domain,s=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?qe(Object(n),!0).forEach(function(t){Te(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):qe(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({username:null,password:null,server:e,host:e,realm:e,serviceType:"xmpp",serviceName:e},n);return new Promise(function(e,n){function r(t){t.attrs.xmlns===$e&&("challenge"!==t.name?("failure"===t.name?n(Xe.fromElement(t)):"success"===t.name&&e(),o.removeListener("nonza",r)):(i.challenge(Ue(t.text())),t=i.response(s),o.send(ut("response",{xmlns:$e,mechanism:i.name},"string"==typeof t?Be(t):""))))}o.on("nonza",r),i.clientFirst&&o.send(ut("auth",{xmlns:$e,mechanism:i.name},Be(i.response(s))))})});function De(t,e){if(!e)return t&&t.then?t.then(Ie):Promise.resolve()}var Be=Ne.encode,Ue=Ne.decode;function We(n){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(n.apply(this,t))}catch(t){return Promise.reject(t)}}}var $e="urn:ietf:params:xml:ns:xmpp-sasl";var He=function(t,s){var t=t.streamFeatures,a=new Fe;return t.use("mechanisms",$e,We(function(t){var e,n=t.stanza,r=t.entity,o=n.getChild("mechanisms",$e).children.map(function(t){return t.text()}),i=a._mechs.map(function(t){return t.name}).filter(function(t){return o.includes(t)})[0];return e=function(){return De(r.restart())},(t=(t=function(){return"function"==typeof s?De(s(function(t){return ze(a,r,i,t,n)},i)):(s.username||s.password||(i="ANONYMOUS"),De(ze(a,r,i,s,n)))})())&&t.then?t.then(e):e(t)})),{use:function(){return a.use.apply(a,arguments)}}};function Ke(t,e,n){return n?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var Ye=Je(function(e,t,n){return Ke(t.set(ut("bind",{xmlns:Ge},(n=n)&&ut("resource",{},n))),function(t){t=t.getChildText("jid");return e._jid(t),t})});function Je(n){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(n.apply(this,t))}catch(t){return Promise.reject(t)}}}var Ge="urn:ietf:params:xml:ns:xmpp-bind";var Qe=function(t,e){var r,o,n=t.streamFeatures,t=t.iqCaller;n.use("bind",Ge,(r=e,o={iqCaller:t}.iqCaller,Je(function(t,e){var n=t.entity;return Ke("function"==typeof r?r(function(t){return Ye(n,o,t)}):Ye(n,o,r),function(){e()})})))};var Ve="urn:ietf:params:xml:ns:xmpp-session",Ze=function(t){var n,i=t.iqCaller;t.streamFeatures.use("session",Ve,(n=function(t,e,n){return n.getChild("optional")?e():(r=i.set(ut("session",Ve)),n=function(){return e()},o?n?n(r):r:(r&&r.then||(r=Promise.resolve(r)),n?r.then(n):r));var r,o},function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(n.apply(this,t))}catch(t){return Promise.reject(t)}}))};function tn(t,e,n){return n?e?e(t):t:(t&&t.then||(t=Promise.resolve(t)),e?t.then(e):t)}var en=sn(function(t,e,n){return tn(t.sendReceive(ut("resume",{xmlns:on,h:e,previd:n})),function(t){if(!t.is("resumed",on))throw t;return t})});function nn(t,e){try{var n=t()}catch(t){return e(t)}return n&&n.then?n.then(void 0,e):n}var rn=sn(function(o,t,e){return o.send(ut("enable",{xmlns:on,max:e,resume:t?"true":void 0})),new Promise(function(n,r){o.on("nonza",function t(e){if(e.is("enabled",on))n(e);else{if(!e.is("failed",on))return;r(e)}o.removeListener("nonza",t)})})});var on="urn:xmpp:sm:3";function sn(n){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{return Promise.resolve(n.apply(this,t))}catch(t){return Promise.reject(t)}}}var an=function(t){var e=t.streamFeatures,i=t.entity,t=t.middleware,s=null,a={allowResume:!0,preferredMaximum:null,enabled:!1,id:"",outbound:0,inbound:0,max:null};return i.on("online",function(t){s=t,a.outbound=0,a.inbound=0}),i.on("offline",function(){a.outbound=0,a.inbound=0,a.enabled=!1,a.id=""}),t.use(function(t,e){t=t.stanza;return["presence","message","iq"].includes(t.name)?a.inbound+=1:t.is("r",on)?i.send(ut("a",{xmlns:on,h:a.inbound})).catch(function(){}):t.is("a",on)&&(a.outbound=t.attrs.h),e()}),e.use("sm",on,sn(function(t,e){var n,r,o=!1;return r=function(t){return o?t:function(t,e,n){if(n)return e?e(t()):t();try{var r=Promise.resolve(t());return e?r.then(e):r}catch(t){return Promise.reject(t)}}(e,function(){var t,e,n=rn(i,a.allowResume,a.preferredMaximum);return a.outbound=0,t=nn(function(){return tn(n,function(t){a.enabled=!0,a.id=t.attrs.id,a.max=t.attrs.max})},function(){a.enabled=!1}),e=function(){a.inbound=0},t&&t.then?t.then(e):e(t)})},(n=(n=function(){if(a.id)return nn(function(){return tn(en(i,a.inbound,a.id),function(){return a.enabled=!0,i.jid=s,i.status="online",o=!0})},function(){a.id="",a.enabled=!1,a.outbound=0})})())&&n.then?n.then(r):r(n)})),a};r=function(t,e,n){(e.exports=n).Mechanism=n},"object"==typeof(un={exports:{}}).exports&&r(un.exports,un,n({}));var un=un.exports,cn=function(t){t.use(un)};n=function(t,e,n){(e.exports=n).Mechanism=n},"object"==typeof(ln={exports:{}}).exports&&n(ln.exports,ln,e({}));var ln=ln.exports,fn=function(t){t.use(ln)},n={},hn=u(o),pn=["resource","credentials","username","password"],e=_.xml,o=_.jid,dn=_.Client;return n.xml=e,n.jid=o,n.client=function(t){var e=t=void 0===t?{}:t,n=t.resource,r=t.credentials,o=t.username,i=t.password,s=(f=(0,hn.default)(t,pn)).domain,a=f.service;!s&&a&&(f.domain=St(a));var u=new dn(f),c=Mt({entity:u}),l=Kt({entity:u}),t=ne({entity:u}),e=oe({middleware:t}),s=he({middleware:t,entity:u}),a=be({middleware:t,entity:u}),f=Ce({entity:u}),h=He({streamFeatures:e},r||{username:o,password:i}),r=an({streamFeatures:e,entity:u,middleware:t}),o=Qe({iqCaller:s,streamFeatures:e},n),i=Ze({iqCaller:s,streamFeatures:e}),n=Object.entries({plain:fn,anonymous:cn}).map(function(t){var e=t[0],n=t[1],t={};return t[e]=n(h),t});return Object.assign(u,{entity:u,reconnect:c,websocket:l,middleware:t,streamFeatures:e,iqCaller:s,iqCallee:a,resolve:f,sasl:h,resourceBinding:o,sessionEstablishment:i,streamManagement:r,mechanisms:n})},n});
//# sourceMappingURL=xmpp.min.js.map